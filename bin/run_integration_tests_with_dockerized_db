#!/bin/bash

set -e

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
readonly SCRIPT_DIR
declare -r DOCKER_COMPOSE_CONFIG_FILE="${SCRIPT_DIR}"/configs/integration-tests.yaml
declare -r DATABASE_URL=postgres://test-user:test-pw@baseterm-pg-instance:5432/baseterm

trap cleanup EXIT
function cleanup() {
  docker compose -f "${DOCKER_COMPOSE_CONFIG_FILE}" down
}

"${SCRIPT_DIR}"/helpers/build_api_docker_image --development --tag baseterm-api:dev
docker compose -f "${DOCKER_COMPOSE_CONFIG_FILE}" up --detach
docker run \
  --rm \
  --network baseterm-integration-tests-net \
  -e APP_ENV=dev \
  -e AUTH_SECRET=killjoy \
  -e DATABASE_URL="${DATABASE_URL}" \
  baseterm-api:dev \
  npm exec -- jest --coverage --forceExit

